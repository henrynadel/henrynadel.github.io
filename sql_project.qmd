---
title: "Analysing Policing with SQL"
format: html
---

```{r setup, include=FALSE}
library(DBI)
library(RMariaDB)
library(dplyr)
library(ggplot2)

con_traffic <- DBI::dbConnect(
  RMariaDB::MariaDB(),
  dbname   = "traffic",
  host     = Sys.getenv("TRAFFIC_HOST"),
  user     = Sys.getenv("TRAFFIC_USER"),
  password = Sys.getenv("TRAFFIC_PWD")
)
```

## Overview

In this project, I look at policing patterns across four New England states: Connecticut, Massachusetts, Rhode Island, and Vermont, using data from the Stanford Open Policing Project. Unfortunately, New Hampshire could not be included because the data did not include all of the necessary values. The goal of this research is simple: use SQL to pull together large statewide stop records, and then use R to visualize my two core questions:

1. What is the racial breakdown of who is being searched during traffic stops?

2. When searches do happen, at what rates is contraband found?

These questions were chosen because of the light they can shed on where officer discretion, racial bias, and assumptions about criminality become visible. By comparing search rates and hit rates side-by-side, we can see where enforcement patterns align with actual evidence, and where they don't.

## Search Rates by State and Race

```{sql, connection=con_traffic, output.var="search_rates"}
SELECT
state,
race,
COUNT(*) AS n_stops,
SUM(search_conducted) AS n_searches,
ROUND(100.0 * SUM(search_conducted) / COUNT(*), 1) AS search_rate_pct
FROM (
SELECT
'CT' AS state,
LOWER(subject_race) AS race,
search_conducted,
contraband_found
FROM ct_statewide_2020_04_01
WHERE subject_race IS NOT NULL

UNION ALL
SELECT
'MA',
LOWER(subject_race),
search_conducted,
contraband_found
FROM ma_statewide_2020_04_01
WHERE subject_race IS NOT NULL

UNION ALL
SELECT
'RI',
LOWER(subject_race),
search_conducted,
contraband_found
FROM ri_statewide_2020_04_01
WHERE subject_race IS NOT NULL

UNION ALL
SELECT
'VT',
LOWER(subject_race),
search_conducted,
contraband_found
FROM vt_statewide_2020_04_01
WHERE subject_race IS NOT NULL
) AS ne_statewide
GROUP BY state, race
HAVING COUNT(*) >= 100
ORDER BY state, race
```

```{r}
search_rates <- search_rates |>
  filter(!is.na(race) & race != "unknown")

search_rates$race <- factor(search_rates$race)
search_rates$state <- factor(search_rates$state)

ggplot(search_rates,
aes(x = state, y = search_rate_pct, fill = race)) +
geom_col(position = "dodge") +
scale_fill_brewer(palette = "Set2") +
labs(
title = "Search Rates by State and Race (CT, MA, RI, VT)",
x = "State",
y = "Search Rate (% of Stops)",
fill = "Race"
) +
theme_minimal(base_size = 14)
```

This plot shows that search rates are not evenly distributed across racial groups, and the patterns differ across states. Across every state shown above, Black and Hispanic drivers are searched at substantially higher rates than white drivers. This is especially pronounced in Connecticut and Rhode Island, where Black drivers face search rates around 7%, compared to roughly 3% for white drivers. Hispanic drivers show similarly elevated rates—around 6–7% in CT and RI.

Massachusetts and Vermont have lower overall search activity, but the racial pattern still remains: Black and Hispanic drivers are searched more than white drivers, while Asian/Pacific Islander drivers consistently face the lowest search rates across the region. The "other" and "unknown" categories vary but rarely approach the higher search pressure placed on Black and Hispanic motorists. What emerges here is not just cross-state variation but a consistent structure: race strongly predicts the likelihood of being searched, and white drivers are the least likely to be searched in every state in the dataset.


## Contraband Hit Rates by State and Race (Among Searched Stops)

```{sql, connection=con_traffic, output.var="hit_rates"}
SELECT
state,
race,
SUM(search_conducted) AS n_searches,
SUM(CASE WHEN contraband_found = 1 THEN 1 ELSE 0 END) AS n_hits,
ROUND(
100.0 *
SUM(CASE WHEN contraband_found = 1 THEN 1 ELSE 0 END)
/ NULLIF(SUM(search_conducted), 0),
1
) AS hit_rate_pct
FROM (
SELECT
'CT' AS state,
LOWER(subject_race) AS race,
search_conducted,
contraband_found
FROM ct_statewide_2020_04_01
WHERE subject_race IS NOT NULL

UNION ALL
SELECT
'MA',
LOWER(subject_race),
search_conducted,
contraband_found
FROM ma_statewide_2020_04_01
WHERE subject_race IS NOT NULL

UNION ALL
SELECT
'RI',
LOWER(subject_race),
search_conducted,
contraband_found
FROM ri_statewide_2020_04_01
WHERE subject_race IS NOT NULL

UNION ALL
SELECT
'VT',
LOWER(subject_race),
search_conducted,
contraband_found
FROM vt_statewide_2020_04_01
WHERE subject_race IS NOT NULL
) AS ne_statewide
GROUP BY state, race
HAVING SUM(search_conducted) >= 50
ORDER BY state, race
```

```{r}
hit_rates <- hit_rates |>
  filter(!is.na(race) & race != "unknown")

hit_rates$race <- factor(hit_rates$race)

ggplot(hit_rates,
aes(x = race, y = hit_rate_pct, fill = state)) +
geom_col(position = "dodge") +
scale_fill_brewer(palette = "Set2") +
labs(
title = "Contraband Hit Rates by Race and State \n (Among Searched Stops)",
x = "Race",
y = "Hit Rate (% of Searches)"
) +
theme_minimal(base_size = 14)
```
The second plot flips the lens: instead of who gets searched, it explores what police actually find when they conduct a search. The results tell a different story, one that goes against an assumption that higher search rates correspond to higher levels of contraband.

Across states, white drivers consistently show some of the highest contraband hit rates, especially in Vermont, where searches of white drivers turn up contraband nearly 90% of the time. Black and Hispanic drivers, who are searched far more often, show much lower hit rates—usually ranging from the high teens to the mid-40s depending on the state.
This mismatch—higher search rates paired with lower hit rates—is especially stark in Connecticut and Rhode Island.

In short, the communities searched most aggressively are not the ones most likely to be found with contraband. Instead, white drivers, searched the least often, show the highest probability of a "successful" search.

This pattern displays a clear racial disparity in search rates, and shows that they are driven more by bias and over-policing, rather than by actual behavior.


## Conclusion

By merging four statewide datasets and visualizing search and hit rates, a clear pattern emerges: Black and Hispanic drivers are searched far more often, yet those searches uncover contraband less frequently than searches of white drivers. This holds across every state in the dataset. In other words, the groups searched the most are not the ones most likely to have contraband. That mismatch points toward discretionary enforcement shaped more by racial bias than by evidence. Even with New Hampshire excluded, the trend is unmistakable: search practices in these New England states fall unevenly along racial lines, and the data make that disparity impossible to explain away on the basis of "risk.

```{r}
DBI::dbDisconnect(con_traffic)
```

## Citation:

Pierson, Emma, Camelia Simoiu, Jan Overgoor, Sam Corbett-Davies, Daniel Jenson, Amy Shoemaker, Vignesh Ramachandran, et al. 2020. "A Large-Scale Analysis of Racial Disparities in Police Stops Across the United States." Nature Human Behaviour, 1–10.